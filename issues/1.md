# Реализовать выбор звуковых оповещений через UI для клиентов и администраторов

Добавить полноценную возможность выбора мелодии звукового уведомления через пользовательский интерфейс для клиентов и администраторов.

# Требования
1. Вынести звуковые файлы в отдельную папку (например, /sounds/notification-default.mp3, /sounds/notification-bell.mp3 и т.д.)
2. Передавать список доступных звуковых файлов в JS через wp_localize_script (WordPress).
3. Для админов — выпадающий список в настройках WordPress для выбора звука по умолчанию.
4. Для клиентов — модальное окно или селектор в чате для выбора мелодии оповещения.
5. Сохранять выбор клиента в localStorage, для админа — в опциях WP.
6. Кнопка "Прослушать" для каждой мелодии.
7. При получении нового сообщения использовать выбранный звук для уведомления.
8. Поддерживать добавление новых звуков простым копированием файла в папку /sounds/.
9. Документировать процедуру добавления новых звуков в README и настройках.

# Примеры кода

## 1. PHP: Изменения в ai-multilingual-chat.php

Добавить в функцию enqueue_admin_scripts():
```php
wp_localize_script('aic-admin-script', 'aicAdmin', array(
    'ajax_url' => admin_url('admin-ajax.php'),
    'nonce' => wp_create_nonce('aic_admin_nonce'),
    'sound_base_url' => plugins_url('sounds/', __FILE__),
    'sound_choice' => get_option('aic_admin_notification_sound', 'default'),
    'available_sounds' => array(
        'default' => 'По умолчанию',
        'bell' => 'Колокольчик',
        'ding' => 'Динь',
        'chime' => 'Перезвон',
        'soft' => 'Мягкий'
    ),
    // ... остальные параметры
));
```

Добавить в функцию enqueue_frontend_scripts():
```php
wp_localize_script('aic-frontend-script', 'aicFrontend', array(
    // ... существующие параметры
    'sound_base_url' => plugins_url('sounds/', __FILE__),
    'available_sounds' => array(
        'default' => 'По умолчанию',
        'bell' => 'Колокольчик',
        'ding' => 'Динь',
        'chime' => 'Перезвон',
        'soft' => 'Мягкий'
    ),
));
```

## 2. PHP: Изменения в templates/settings.php

Добавить в секцию настроек звука:
```php
<tr>
    <th scope="row">
        <label for="aic_admin_notification_sound">Мелодия оповещения для админов</label>
    </th>
    <td>
        <?php $admin_sound = get_option('aic_admin_notification_sound', 'default'); ?>
        <select id="aic_admin_notification_sound" name="aic_admin_notification_sound">
            <option value="default" <?php selected($admin_sound, 'default'); ?>>По умолчанию</option>
            <option value="bell" <?php selected($admin_sound, 'bell'); ?>>Колокольчик</option>
            <option value="ding" <?php selected($admin_sound, 'ding'); ?>>Динь</option>
            <option value="chime" <?php selected($admin_sound, 'chime'); ?>>Перезвон</option>
            <option value="soft" <?php selected($admin_sound, 'soft'); ?>>Мягкий звук</option>
        </select>
        <button type="button" class="button" id="aic_preview_admin_sound" style="margin-left: 10px;">
            <span class="dashicons dashicons-controls-volumeon"></span> Прослушать
        </button>
        <p class="description">Выберите звук оповещения о новых сообщениях в админ-панели</p>
        
        <script>
        jQuery(document).ready(function($) {
            $('#aic_preview_admin_sound').on('click', function() {
                var soundChoice = $('#aic_admin_notification_sound').val();
                var soundUrl = '<?php echo plugins_url('sounds/', dirname(__FILE__)); ?>notification-' + soundChoice + '.mp3';
                var audio = new Audio(soundUrl);
                audio.play().catch(function(e) {
                    console.log('Could not play sound:', e);
                });
            });
        });
        </script>
    </td>
</tr>
```

## 3. JavaScript: Изменения в admin-script.js

Заменить функцию initNotificationSound:
```javascript
initNotificationSound: function() {
    // Получить выбор из настроек WordPress
    const soundChoice = aicAdmin.sound_choice || 'default';
    const soundUrl = aicAdmin.sound_base_url + 'notification-' + soundChoice + '.mp3';
    
    this.notificationSound = new Audio(soundUrl);
    
    // Fallback на default если выбранный звук не загрузился
    this.notificationSound.addEventListener('error', function() {
        console.log('Failed to load sound:', soundChoice, 'falling back to default');
        this.src = aicAdmin.sound_base_url + 'notification-default.mp3';
    });
},
```

## 4. JavaScript: Изменения в frontend-script.js

Заменить функцию initNotificationSound:
```javascript
initNotificationSound: function() {
    // Load user's sound preference from localStorage
    const savedSoundEnabled = localStorage.getItem('aic_sound_enabled');
    if (savedSoundEnabled !== null) {
        this.soundEnabled = savedSoundEnabled === 'true';
    }
    
    // Load sound choice
    const soundChoice = localStorage.getItem('aic_client_notification_sound') || 'default';
    const soundUrl = aicFrontend.sound_base_url + 'notification-' + soundChoice + '.mp3';
    
    this.notificationSound = new Audio(soundUrl);
    
    // Fallback на default если выбранный звук не загрузился
    const self = this;
    this.notificationSound.addEventListener('error', function() {
        console.log('Failed to load sound:', soundChoice, 'falling back to default');
        self.notificationSound = new Audio(aicFrontend.sound_base_url + 'notification-default.mp3');
    });
},
```

Добавить функции для работы с UI выбора звука:
```javascript
// Открыть модальное окно выбора звука
openSoundSettings: function() {
    $('#aic-sound-settings-modal').fadeIn(300);
    
    // Установить текущий выбор
    const currentSound = localStorage.getItem('aic_client_notification_sound') || 'default';
    $('input[name="aic_sound_choice"][value="' + currentSound + '"]').prop('checked', true);
},

// Прослушать звук
previewSound: function(soundChoice) {
    const soundUrl = aicFrontend.sound_base_url + 'notification-' + soundChoice + '.mp3';
    const previewAudio = new Audio(soundUrl);
    previewAudio.play().catch(function(e) {
        console.log('Could not play preview sound:', e);
    });
},

// Сохранить выбор
saveSoundChoice: function() {
    const selectedSound = $('input[name="aic_sound_choice"]:checked').val();
    localStorage.setItem('aic_client_notification_sound', selectedSound);
    
    // Переинициализировать звук с новым выбором
    this.initNotificationSound();
    
    // Закрыть модальное окно
    $('#aic-sound-settings-modal').fadeOut(300);
    
    // Показать toast уведомление
    this.showToast('Мелодия сохранена!');
},

// Показать toast уведомление
showToast: function(message) {
    const toast = $('<div class="aic-toast">' + message + '</div>');
    $('body').append(toast);
    toast.fadeIn(300);
    setTimeout(function() {
        toast.fadeOut(300, function() {
            $(this).remove();
        });
    }, 2000);
},

// В функции bindEvents() добавить:

// Открыть настройки звука
$(document).on('click', '#aic-sound-settings-btn', function() {
    self.openSoundSettings();
});

// Закрыть модальное окно
$(document).on('click', '#aic-sound-modal-close, #aic-sound-settings-modal', function(e) {
    if (e.target.id === 'aic-sound-settings-modal' || e.target.id === 'aic-sound-modal-close') {
        $('#aic-sound-settings-modal').fadeOut(300);
    }
});

// Прослушать звук
$(document).on('click', '.aic-preview-sound-btn', function() {
    const soundChoice = $(this).data('sound');
    self.previewSound(soundChoice);
});

// Сохранить выбор
$(document).on('click', '#aic-save-sound-choice', function() {
    self.saveSoundChoice();
});
```

## 5. HTML: Добавить в templates/chat-widget.php

Добавить кнопку настроек звука в заголовок чата (рядом с кнопкой переключения звука):
```html
<button id="aic-sound-settings-btn" class="aic-icon-button" title="Настройки звука">
    <span class="dashicons dashicons-admin-generic" style="font-size: 16px;"></span>
</button>
```

Добавить модальное окно в конец файла:
```html
<!-- Sound Settings Modal -->
<div id="aic-sound-settings-modal" class="aic-modal" style="display:none;">
    <div class="aic-modal-content">
        <div class="aic-modal-header">
            <h3>Выбор мелодии оповещения</h3>
            <button id="aic-sound-modal-close" class="aic-modal-close">&times;</button>
        </div>
        <div class="aic-modal-body">
            <div class="aic-sound-options">
                <label class="aic-sound-option">
                    <input type="radio" name="aic_sound_choice" value="default" checked>
                    <span class="aic-sound-name">По умолчанию</span>
                    <button type="button" class="aic-preview-sound-btn" data-sound="default">
                        <span class="dashicons dashicons-controls-volumeon"></span>
                    </button>
                </label>
                
                <label class="aic-sound-option">
                    <input type="radio" name="aic_sound_choice" value="bell">
                    <span class="aic-sound-name">Колокольчик</span>
                    <button type="button" class="aic-preview-sound-btn" data-sound="bell">
                        <span class="dashicons dashicons-controls-volumeon"></span>
                    </button>
                </label>
                
                <label class="aic-sound-option">
                    <input type="radio" name="aic_sound_choice" value="ding">
                    <span class="aic-sound-name">Динь</span>
                    <button type="button" class="aic-preview-sound-btn" data-sound="ding">
                        <span class="dashicons dashicons-controls-volumeon"></span>
                    </button>
                </label>
                
                <label class="aic-sound-option">
                    <input type="radio" name="aic_sound_choice" value="chime">
                    <span class="aic-sound-name">Перезвон</span>
                    <button type="button" class="aic-preview-sound-btn" data-sound="chime">
                        <span class="dashicons dashicons-controls-volumeon"></span>
                    </button>
                </label>
                
                <label class="aic-sound-option">
                    <input type="radio" name="aic_sound_choice" value="soft">
                    <span class="aic-sound-name">Мягкий звук</span>
                    <button type="button" class="aic-preview-sound-btn" data-sound="soft">
                        <span class="dashicons dashicons-controls-volumeon"></span>
                    </button>
                </label>
            </div>
        </div>
        <div class="aic-modal-footer">
            <button type="button" id="aic-save-sound-choice" class="aic-button-primary">Сохранить</button>
        </div>
    </div>
</div>
```

## 6. CSS: Добавить стили в chat-widget.php или отдельный CSS файл

```css
/* Modal Styles */
.aic-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 100000;
    display: flex;
    align-items: center;
    justify-content: center;
}

aic-modal-content {
    background: white;
    border-radius: 8px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

aic-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
}

aic-modal-header h3 {
    margin: 0;
    font-size: 18px;
    color: #333;
}

aic-modal-close {
    background: transparent;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #999;
    line-height: 1;
    padding: 0;
}

aic-modal-close:hover {
    color: #333;
}

aic-modal-body {
    padding: 20px;
}

aic-sound-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

aic-sound-option {
    display: flex;
    align-items: center;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
}

aic-sound-option:hover {
    border-color: #667eea;
    background: #f5f7ff;
}

aic-sound-option input[type="radio"] {
    margin-right: 12px;
    cursor: pointer;
}

aic-sound-option input[type="radio"]:checked + .aic-sound-name {
    color: #667eea;
    font-weight: 600;
}

aic-sound-option:has(input:checked) {
    border-color: #667eea;
    background: #f5f7ff;
}

aic-sound-name {
    flex: 1;
    font-size: 14px;
    color: #333;
}

aic-preview-sound-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    color: #667eea;
    padding: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
}

aic-preview-sound-btn:hover {
    transform: scale(1.2);
}

aic-modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
}

aic-button-primary {
    background: #667eea;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: background 0.3s;
}

aic-button-primary:hover {
    background: #5568d3;
}

/* Toast notification */
.aic-toast {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: #4caf50;
    color: white;
    padding: 15px 25px;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 100001;
    display: none;
    animation: toastSlideIn 0.3s ease;
}

@keyframes toastSlideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}