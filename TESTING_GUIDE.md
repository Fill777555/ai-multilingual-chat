# Руководство по тестированию исправлений v2.0

## Обзор
Это руководство поможет вам проверить исправления двух критических проблем, возникших после обновления до версии 2.0:
1. Дублирование сообщений на фронтенде
2. Проблемы с управлением диалогами в админпанели

## Автоматические тесты

### Тест дублирования сообщений
Запустите простой тест для проверки исправления:

```bash
cd wp-content/plugins/ai-multilingual-chat
node tests/test-duplication-simple.js
```

**Ожидаемый результат**: Тест должен показать, что с исправлением сообщения не дублируются.

## Ручное тестирование

### 1. Тестирование дублирования сообщений (Фронтенд)

#### Шаги для проверки:

1. **Откройте сайт** в режиме инкогнито или очистите localStorage
   - Откройте DevTools (F12)
   - Перейдите на вкладку Console

2. **Откройте виджет чата**
   - Нажмите на кнопку чата в правом нижнем углу
   - Введите ваше имя и выберите язык
   - Нажмите "Начать чат"

3. **Отправьте тестовое сообщение**
   - Введите: "Здравствуйте, мне нужна помощь!"
   - Нажмите Enter или кнопку отправки
   - Сразу увидите сообщение (это нормально - оптимистичное отображение)

4. **Проверьте консоль**
   В консоли должны появиться логи:
   ```
   Сообщение отправлено: {success: true, data: {...}}
   Updated lastMessageId to: [число]
   ```

5. **Подождите 3-4 секунды**
   - Это время следующего опроса сервера
   - В консоли появится лог загрузки сообщений

6. **Проверьте результат**
   - ✅ **УСПЕХ**: Сообщение показано ОДИН раз
   - ❌ **ОШИБКА**: Сообщение показано ДВА раза (дубликат через ~3 секунды)

#### Что исправлено:
- После отправки сообщения, `lastMessageId` обновляется ID сообщения с сервера
- При следующем опросе сервер возвращает только сообщения с `id > lastMessageId`
- Только что отправленное сообщение пропускается → нет дубликата

### 2. Тестирование админпанели (Управление диалогами)

#### Шаги для проверки:

1. **Войдите в админпанель WordPress**
   - Перейдите в AI Chat → Управление диалогами

2. **Откройте DevTools Console**
   - Нажмите F12 → вкладка Console

3. **Проверьте логи инициализации**
   Вы должны увидеть:
   ```
   Admin chat page detected, initializing...
   Admin chat initialization started
   Checking for #aic-conversations element: true
   Admin chat initialized successfully
   ```

4. **Проверьте загрузку диалогов**
   В консоли должно быть:
   ```
   loadConversations called
   aicAdmin object: {ajax_url: "...", nonce: "...", ...}
   Диалоги загружены: {success: true, data: {...}}
   Found conversations: [число]
   ```

5. **Проверьте интерфейс**
   - ✅ Слева отображается список диалогов
   - ✅ При клике на диалог открывается чат справа
   - ✅ Отображается история сообщений
   - ✅ Присутствует текстовое поле для ввода
   - ✅ Есть кнопка "Отправить"

6. **Отправьте тестовое сообщение**
   - Выберите диалог
   - Введите сообщение в текстовое поле
   - Нажмите "Отправить"
   - В консоли должен появиться лог:
     ```
     Сообщение отправлено: {success: true, ...}
     ```

#### Диагностика проблем (если что-то не работает):

**Проблема**: Не отображаются диалоги
- Проверьте консоль на ошибки AJAX
- Проверьте, что в логе есть `Found conversations: 0` (нет диалогов) или число > 0
- Если ошибка AJAX, проверьте права доступа и nonce

**Проблема**: Нет текстового поля
- Проверьте лог: `HTML rendered, input field present: true`
- Если `false`, проверьте консоль на JavaScript ошибки
- Убедитесь, что выбран диалог (должно быть `renderMessages called with N messages`)

**Проблема**: Ошибка при отправке
- Проверьте консоль на детали ошибки
- Проверьте XHR лог для деталей запроса/ответа

### 3. Сценарий полного цикла (E2E тест)

#### Подготовка:
1. Откройте два окна браузера:
   - Окно 1: Фронтенд сайта (режим инкогнито)
   - Окно 2: Админпанель WordPress → AI Chat

2. В обоих окнах откройте DevTools Console

#### Тест:

**Шаг 1**: Пользователь начинает чат
- В окне 1 (фронтенд): Откройте виджет чата, введите имя, начните чат
- ✅ В окне 2 (админ): Должен появиться новый диалог в списке (обновление через 5 сек)

**Шаг 2**: Пользователь отправляет сообщение
- В окне 1: Напишите "Здравствуйте!" и отправьте
- ✅ Сообщение должно появиться ОДИН раз в окне 1
- ✅ В окне 2: Сообщение должно появиться в диалоге (через 5 сек)

**Шаг 3**: Админ отвечает
- В окне 2: Выберите диалог, напишите ответ "Здравствуйте! Чем могу помочь?" и отправьте
- ✅ Сообщение должно появиться в окне 2

**Шаг 4**: Пользователь получает ответ
- В окне 1: Через 3 секунды должен появиться ответ админа
- ✅ Ответ показан ОДИН раз

**Шаг 5**: Продолжение диалога
- Отправьте несколько сообщений туда-обратно
- ✅ Никаких дубликатов не появляется
- ✅ Все сообщения доставляются корректно

## Что делать при обнаружении проблем

### Если сообщения всё ещё дублируются:

1. **Проверьте версию файлов**
   ```bash
   grep -n "Updated lastMessageId to" wp-content/plugins/ai-multilingual-chat/ai-multilingual-chat/frontend-script.js
   ```
   Должна быть строка с этим логом

2. **Очистите кэш браузера**
   - Ctrl+Shift+Delete → Очистить кэш
   - Перезагрузите страницу с Ctrl+F5

3. **Проверьте консоль на ошибки**
   - Откройте DevTools → Console
   - Ищите красные ошибки JavaScript

### Если админпанель не работает:

1. **Проверьте логи инициализации**
   - Должны быть логи из пункта 2.3

2. **Проверьте AJAX запросы**
   - DevTools → Network → XHR
   - Найдите запросы к admin-ajax.php
   - Проверьте ответы (должны быть success: true)

3. **Проверьте права доступа**
   - Убедитесь, что вы вошли как администратор
   - Проверьте, что плагин активирован

## Технические детали

### Файлы с изменениями:

1. **frontend-script.js** (строки ~182-184)
   - Добавлено обновление `lastMessageId` после отправки сообщения

2. **admin-script.js** (несколько мест)
   - Добавлено логирование для диагностики
   - Улучшена обработка ошибок

### Механизм работы исправления:

```javascript
// До исправления:
sendMessage() → addMessage() → AJAX отправка → (lastMessageId не обновлен)
→ Polling через 3 сек → Находит то же сообщение → Дубликат!

// После исправления:
sendMessage() → addMessage() → AJAX отправка → lastMessageId = message_id
→ Polling через 3 сек → Не находит сообщение (id не > lastMessageId) → Нет дубликата!
```

## Контрольный список проверки

- [ ] Автоматический тест `test-duplication-simple.js` пройден
- [ ] Ручной тест фронтенда: сообщения не дублируются
- [ ] Админпанель: отображается список диалогов
- [ ] Админпанель: присутствует текстовое поле ввода
- [ ] Админпанель: можно отправлять сообщения
- [ ] E2E тест: полный цикл общения работает без ошибок
- [ ] Консоль браузера не содержит JavaScript ошибок
- [ ] AJAX запросы выполняются успешно (status 200, success: true)

## Поддержка

Если проблемы остаются после проверки всех пунктов:

1. Сохраните логи из консоли браузера
2. Сделайте скриншоты проблемы
3. Укажите версию WordPress и PHP
4. Опишите шаги для воспроизведения
5. Создайте issue в репозитории с этой информацией

---

**Версия**: 2.0.1
**Дата**: 2025-10-15
**Статус**: Исправления применены и протестированы ✅
